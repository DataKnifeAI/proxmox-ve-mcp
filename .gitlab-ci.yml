stages:
  - build
  - docker

variables:
  IMAGE_NAME: proxmox-ve-mcp

build:
  stage: build
  image: golang:1.23-alpine
  script:
    - apk add --no-cache make git
    - make build
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes

publish:
  stage: docker
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  dependencies:
    - build
  before_script:
    - mkdir -p ~/.docker
    - |
      AUTH_TOKEN=$(printf "%s:%s" "$HARBOR_USERNAME" "$HARBOR_PASSWORD" | base64 | tr -d '\n')
      echo "Debug: AUTH_TOKEN length: ${#AUTH_TOKEN}"
      echo "Debug: DOCKER_CONFIG_TEMPLATE is set: $([ -n "$DOCKER_CONFIG_TEMPLATE" ] && echo 'yes' || echo 'no')"
      if [ -n "$DOCKER_CONFIG_TEMPLATE" ]; then
        echo "Debug: Using DOCKER_CONFIG_TEMPLATE"
        echo "Debug: Template (first 100 chars): ${DOCKER_CONFIG_TEMPLATE:0:100}"
        echo "$DOCKER_CONFIG_TEMPLATE" | sed "s|AUTH_TOKEN_PLACEHOLDER|$AUTH_TOKEN|g" > ~/.docker/config.json
        echo "Debug: Config file after sed replacement (first 200 chars):"
        head -c 200 ~/.docker/config.json || cat ~/.docker/config.json
        echo ""
      else
        echo "Debug: Using fallback JSON creation"
        echo "{
          \"auths\": {
            \"$HARBOR_REGISTRY\": {
              \"auth\": \"$AUTH_TOKEN\"
            }
          }
        }" > ~/.docker/config.json
      fi
    - |
      echo "=== BuildKit Debug: Checking authentication config ==="
      echo "HOME=$HOME"
      echo "DOCKER_CONFIG=${DOCKER_CONFIG:-not set (using default ~/.docker)}"
      test -f ~/.docker/config.json && echo "✓ ~/.docker/config.json exists" || echo "✗ ~/.docker/config.json missing"
    - |
      echo "Config file exists, showing structure (auth redacted):"
      if [ -f ~/.docker/config.json ]; then
        cat ~/.docker/config.json | grep -v '"auth"' || echo "Config file exists but no auth field found"
      else
        echo "Config file does not exist"
      fi
    - |
      echo "Registry: $HARBOR_REGISTRY"
      echo "Username (first 10 chars): ${HARBOR_USERNAME:0:10}..."
      echo "Password length: ${#HARBOR_PASSWORD} characters"
  script:
    - |
      # Use commit SHA if available, otherwise fall back to pipeline ID
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      echo "=== BuildKit Debug: Starting build ==="
      echo "Image tag: $IMAGE_TAG"
      echo "Registry: $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME"
      
      # Build and push images with BuildKit rootless (multiple outputs for multiple tags)
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$IMAGE_TAG,push=true"
      
      # Add version tag if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG,push=true"
      fi
      
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        $OUTPUT_FLAGS
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes
